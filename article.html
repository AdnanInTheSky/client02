<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loading...</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8f9fa;
    }
    pre code {
      background: #f1f3f5;
      padding: 0.5rem 1rem;
      display: block;
      border-radius: 0.5rem;
      font-size: 0.9rem;
    }
    img {
      max-width: 100%;
      height: auto;
      border-radius: 0.5rem;
    }
    /* Fix for card sizing */
    .card {
      display: flex;
      flex-direction: column;
    }
    .card-img-top {
      width: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-white shadow-sm fixed-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Your NGO</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="articles.html">Articles</a></li>
          <li class="nav-item"><a class="nav-link" href="team.html">Team</a></li>
          <li class="nav-item"><a class="nav-link" href="services.html">Services</a></li>
          <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Article -->
  <main class="container" style="margin-top: 6rem;">
    <div class="card border-0 shadow-sm mb-5" style="max-width: 800px;">
      <img id="article-image" class="card-img-top" src="" alt="Article Image" loading="lazy">
      <div class="card-body">
        <h1 id="article-title" class="card-title fw-bold mb-3">Loading...</h1>
        <div class="text-muted mb-3" id="article-meta">
          <small><span id="article-author">By Unknown</span> â€¢ <span id="article-date">Date Unknown</span></small>
        </div>
        <div id="article-body" class="markdown-body flex-grow-1"></div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-dark text-white text-center py-4">
    <p class="mb-0">&copy; 2025 Your NGO Name. All rights reserved.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function parseYAML(yamlStr) {
      const result = {};
      const lines = yamlStr.trim().split('\n');
      for (const line of lines) {
        const [key, ...valueParts] = line.split(':');
        if (!key) continue;
        const trimmedKey = key.trim();
        let value = valueParts.join(':').trim();
        if (value.startsWith('"') && value.endsWith('"')) value = value.slice(1, -1);
        if (value.startsWith("'") && value.endsWith("'")) value = value.slice(1, -1);
        result[trimmedKey] = value;
      }
      return result;
    }

    // --- Markdown to HTML converter ---
    function markdownToHTML(md) {
      let html = md;

      // Escape HTML
      html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

      // Code blocks
      html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

      // Headings
      html = html.replace(/^### (.+)$/gm, '<h3 class="mt-4">$1</h3>');
      html = html.replace(/^## (.+)$/gm, '<h2 class="mt-4">$1</h2>');
      html = html.replace(/^# (.+)$/gm, '<h1 class="mt-4">$1</h1>');

      // Bold / Italic
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

      // Inline code
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

      // Links
      html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

      // Images
      html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img alt="$1" src="$2" class="img-fluid my-3"/>');

      // Tables
      html = html.replace(/^\|(.+)\|\n\|([\s:-]+)\|\n((\|.+\|\n)+)/gm, (match, header, divider, rows) => {
        const headers = header.split('|').map(h => `<th>${h.trim()}</th>`).join('');
        const body = rows.trim().split('\n').map(r => {
          const cols = r.split('|').map(c => `<td>${c.trim()}</td>`).join('');
          return `<tr>${cols}</tr>`;
        }).join('');
        return `<div class="table-responsive"><table class="table table-bordered align-middle">${headers ? `<thead><tr>${headers}</tr></thead>` : ''}<tbody>${body}</tbody></table></div>`;
      });

      // Lists
      html = html.replace(/^\s*[-*+] (.+)$/gm, '<li>$1</li>');
      html = html.replace(/(<li>.*<\/li>)/gs, '<ul class="ms-3">$1</ul>');

      html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
      html = html.replace(/(<li>.*<\/li>)/gs, '<ol class="ms-3">$1</ol>');

      // Paragraphs
      html = html.replace(/(^|\n)(?!<h|<ul|<ol|<pre|<img|<table|<blockquote|<p|<\/)([^\n]+)(?=\n|$)/g, '$1<p>$2</p>');

      return html;
    }

    async function loadArticle() {
      const id = sessionStorage.getItem('selectedFile');
      if (!id || !id.startsWith('articles/')) {
        document.getElementById('article-body').innerHTML = '<div class="alert alert-danger">Error: Article not found.</div>';
        document.title = 'Article Not Found';
        return;
      }

      try {
        const response = await fetch(`/content/${id}`);
        if (!response.ok) throw new Error('Network response was not ok');
        const text = await response.text();

        const parts = text.split('---');
        if (parts.length < 3) throw new Error('Invalid Markdown format');

        const frontmatter = parts[1];
        const body = parts.slice(2).join('---');
        const meta = parseYAML(frontmatter);
        const htmlBody = markdownToHTML(body);

        document.getElementById('article-image').src = meta.image || '';
        document.getElementById('article-title').textContent = meta.title || 'Untitled';
        document.getElementById('article-author').textContent = `By ${meta.author || 'Unknown'}`;
        document.getElementById('article-date').textContent = meta.date ? new Date(meta.date).toLocaleDateString() : 'Unknown';
        document.getElementById('article-body').innerHTML = htmlBody;
        document.title = meta.title || 'Article';
      } catch (error) {
        console.error('Error loading article:', error);
        document.getElementById('article-body').innerHTML = '<div class="alert alert-danger">Error loading article content.</div>';
      }
    }

    document.addEventListener('DOMContentLoaded', loadArticle);
  </script>
</body>
</html>