<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading...</title>
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Minimal custom CSS — only what Bootstrap doesn’t handle */
        body {
            font-family: 'Inter', sans-serif;
            padding-top: 80px; /* Account for fixed header height */
        }
        .header-fixed {
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .article-hero-img {
            height: 400px;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        @media (max-width: 768px) {
            .article-hero-img {
                height: 250px;
            }
        }
    </style>
</head>
<body>

    <!-- Fixed Header (Bootstrap Navbar) -->
    <header class="header-fixed">
        <nav class="navbar navbar-expand-lg navbar-light bg-white">
            <div class="container">
                <a class="navbar-brand d-lg-none" href="index.html">NGO</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse justify-content-center" id="mainNav">
                    <ul class="navbar-nav">
                        <li class="nav-item"><a class="nav-link px-3" href="index.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link px-3" href="articles.html">Articles</a></li>
                        <li class="nav-item"><a class="nav-link px-3" href="team.html">Team</a></li>
                        <li class="nav-item"><a class="nav-link px-3" href="services.html">Services</a></li>
                        <li class="nav-item"><a class="nav-link px-3" href="contact.html">Contact</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- Article Content -->
    <main class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card border-0 shadow-sm mb-4">
                    <img id="article-image" class="card-img-top article-hero-img" src="" alt="" loading="lazy">
                    <div class="card-body">
                        <h1 id="article-title" class="card-title h2 mb-3">Loading...</h1>
                        <div id="article-meta" class="text-muted small mb-4">
                            <span id="article-author">By Unknown</span> • 
                            <span id="article-date">Date Unknown</span>
                        </div>
                        <div id="article-body" class="article-body fs-5">
                            <!-- Content injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-auto">
        <div class="container text-center">
            <p class="mb-0">&copy; 2024 Your NGO Name. All rights reserved.</p>
        </div>
    </footer>

    <!-- Bootstrap JS (optional for navbar toggle) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- Helper Functions ---

        function parseYAML(yamlStr) {
            const result = {};
            const lines = yamlStr.trim().split('\n');
            for (const line of lines) {
                const match = line.match(/^([^:]+):\s*(.*)$/);
                if (!match) continue;
                let [_, key, value] = match;
                key = key.trim();
                value = value.trim();

                if ((value.startsWith('"') && value.endsWith('"')) ||
                    (value.startsWith("'") && value.endsWith("'"))) {
                    value = value.slice(1, -1);
                }
                else if (value.startsWith('[') && value.endsWith(']')) {
                    value = value.slice(1, -1)
                        .split(',')
                        .map(v => v.trim().replace(/^["'](.*)["']$/, '$1'));
                }
                else if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
                    const date = new Date(value);
                    if (!isNaN(date)) value = date;
                }

                result[key] = value;
            }
            return result;
        }

        function markdownToHTML(md) {
            let lines = md.split('\n');
            let html = '';
            let inList = false;
            let listType = null;
            let inTable = false;
            let tableRows = [];

            function escapeHtml(text) {
                return text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '<')
                    .replace(/>/g, '>')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            function processInline(text) {
                text = text.replace(/`([^`]+)`/g, '<code class="bg-light p-1 rounded">$1</code>');
                text = text.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
                text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
                text = text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" class="img-fluid my-3 rounded">');
                text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-primary">$1</a>');
                return text;
            }

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();

                if (line === '' && !inList && !inTable) continue;

                // Horizontal Rule
                if (/^(-{3,}|\*{3,})$/.test(line)) {
                    if (inList) { html += `</${listType}>`; inList = false; }
                    html += '<hr class="my-4">';
                    continue;
                }

                // Headings
                if (line.startsWith('# ')) {
                    if (inList) { html += `</${listType}>`; inList = false; }
                    html += `<h1 class="h2 mt-4 mb-3">${processInline(line.slice(2))}</h1>`;
                    continue;
                }
                if (line.startsWith('## ')) {
                    if (inList) { html += `</${listType}>`; inList = false; }
                    html += `<h2 class="h3 mt-4 mb-3">${processInline(line.slice(3))}</h2>`;
                    continue;
                }
                if (line.startsWith('### ')) {
                    if (inList) { html += `</${listType}>`; inList = false; }
                    html += `<h3 class="h4 mt-4 mb-3">${processInline(line.slice(4))}</h3>`;
                    continue;
                }

                // Blockquote
                if (line.startsWith('> ')) {
                    if (inList) { html += `</${listType}>`; inList = false; }
                    html += `<blockquote class="blockquote fst-italic ps-3 border-start border-3 border-primary my-3">${processInline(line.slice(2))}</blockquote>`;
                    continue;
                }

                // Ordered List
                const olMatch = line.match(/^(\d+)\.\s+(.+)$/);
                if (olMatch) {
                    const content = processInline(olMatch[2]);
                    if (!inList || listType !== 'ol') {
                        if (inList) html += `</${listType}>`;
                        html += '<ol class="ps-4">';
                        inList = true;
                        listType = 'ol';
                    }
                    html += `<li>${content}</li>`;
                    continue;
                }

                // Unordered List
                const ulMatch = line.match(/^[-*+]\s+(.+)$/);
                if (ulMatch) {
                    const content = processInline(ulMatch[1]);
                    if (!inList || listType !== 'ul') {
                        if (inList) html += `</${listType}>`;
                        html += '<ul class="ps-4">';
                        inList = true;
                        listType = 'ul';
                    }
                    html += `<li>${content}</li>`;
                    continue;
                }

                // Table
                if (line.includes('|') && line.split('|').length > 2) {
                    if (inList) { html += `</${listType}>`; inList = false; }
                    tableRows = [];
                    while (i < lines.length && lines[i].trim().includes('|')) {
                        let rowLine = lines[i].trim();
                        if (rowLine.startsWith('|')) rowLine = rowLine.slice(1);
                        if (rowLine.endsWith('|')) rowLine = rowLine.slice(0, -1);
                        const cells = rowLine.split('|').map(cell => cell.trim());
                        tableRows.push(cells);
                        i++;
                    }
                    i--;

                    if (tableRows.length >= 2) {
                        html += '<div class="table-responsive my-4"><table class="table table-bordered">';
                        html += '<thead class="table-light"><tr>';
                        tableRows[0].forEach(cell => {
                            html += `<th>${processInline(cell)}</th>`;
                        });
                        html += '</tr></thead><tbody>';

                        let startRow = 1;
                        if (tableRows.length > 2 && /^[-:\s|]+$/.test(lines[i - (tableRows.length - 1) + 1])) {
                            startRow = 2;
                        }

                        for (let r = startRow; r < tableRows.length; r++) {
                            html += '<tr>';
                            tableRows[r].forEach(cell => {
                                html += `<td>${processInline(cell)}</td>`;
                            });
                            html += '</tr>';
                        }
                        html += '</tbody></table></div>';
                    }
                    continue;
                }

                // Paragraphs
                let paragraphLines = [];
                while (i < lines.length && lines[i].trim() !== '' &&
                       !lines[i].trim().match(/^# |^## |^### |> |^[-*+]\s|^\d+\.\s|^(-{3,}|\*{3,})$/) &&
                       !lines[i].includes('|')) {
                    paragraphLines.push(lines[i]);
                    i++;
                }
                i--;

                if (paragraphLines.length > 0) {
                    if (inList) { html += `</${listType}>`; inList = false; }
                    let paraText = paragraphLines.join('\n').trim();
                    paraText = processInline(paraText);
                    paraText = paraText.replace(/  \n|\n/g, '<br>');
                    html += `<p class="mb-3">${paraText}</p>`;
                }
            }

            if (inList) html += `</${listType}>`;
            return html;
        }

        // --- Load Article ---
        async function loadArticle() {
            const id = sessionStorage.getItem('selectedFile');

            if (!id || !id.startsWith('articles/')) {
                document.getElementById('article-body').innerHTML = '<p class="text-danger">Error: Article not found.</p>';
                document.title = 'Article Not Found';
                return;
            }

            try {
                const response = await fetch(`/content/${id}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const text = await response.text();

                const parts = text.split(/^---\s*$/m);
                let meta = {}, body = text;
                if (parts.length >= 3 && parts[0].trim() === '') {
                    meta = parseYAML(parts[1]);
                    body = parts.slice(2).join('---\n');
                }

                const htmlBody = markdownToHTML(body);

                const imgEl = document.getElementById('article-image');
                if (meta.image && meta.image.trim()) {
                    imgEl.src = meta.image;
                    imgEl.alt = meta.title || '';
                    imgEl.classList.remove('d-none');
                } else {
                    imgEl.classList.add('d-none');
                }

                document.getElementById('article-title').textContent = meta.title || 'Untitled';
                document.getElementById('article-author').textContent = `By ${meta.author || 'Unknown'}`;
                const date = meta.date instanceof Date ? meta.date : new Date(meta.date || Date.now());
                document.getElementById('article-date').textContent = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('article-body').innerHTML = htmlBody;
                document.title = meta.title || 'Article';

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('article-body').innerHTML = 
                    `<p class="text-danger"><strong>Error:</strong> ${error.message || 'Failed to load article.'}</p>`;
                document.title = 'Error';
            }
        }

        document.addEventListener('DOMContentLoaded', loadArticle);
    </script>
</body>
</html>